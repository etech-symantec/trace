<!DOCTYPE html>
<html lang="ko">
<head>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Dongle&display=swap" rel="stylesheet">
<meta charset="UTF-8">
<title>ProxySG Trace ë¶„ì„ ë„êµ¬</title>
<style>
  body { font-family:"Segoe UI", Arial, sans-serif; background:#f5f7fa; margin:20px; color:#333; }
  .dongle-regular {
    font-family: "Dongle", sans-serif;
    font-weight: 400;
    font-style: normal;
  }

  /* ğŸ”¹ ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ */
  .top-nav {
    display: flex;
    justify-content: flex-end;
    gap: 5px;
    margin-bottom: 5px;
  }

  .nav-btn {
    background: #1e3a5f;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 4px 10px;       /* ì¢Œìš° ì—¬ë°± ì‚´ì§ í™•ë³´ */
    height: 18px;            /* ë²„íŠ¼ ë†’ì´ ê³ ì • */
    line-height: 18px;       /* í…ìŠ¤íŠ¸ë¥¼ ì„¸ë¡œ ì¤‘ì•™ìœ¼ë¡œ ì •ë ¬ */
    cursor: pointer;
    font-weight: 600;
    font-size: 0.75rem;         /* í°íŠ¸ í¬ê¸° ì ˆë°˜ ìˆ˜ì¤€ */
    text-decoration: none;
    transition: background 0.2s;
  }

  .nav-btn:hover {
    background: #294b7a;
  }


  h1 {
  	font-size: 1.5em;
    background: #1e3a5f;
    color: white;
    padding: 12px 18px;
    border-radius: 8px;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    margin-bottom: 5pt;
  }

  .title-left {
    font-size: 1.6em;                   /* ì œëª© í¬ê²Œ */
    line-height: 0.7;                   /* ì¤„ ê°„ê²© ì¤„ì´ê¸° */
    margin-bottom: 0;                   /* ì•„ë˜ ì—¬ë°± ì œê±° */
  }

  .subtitle {
    font-size: 0.7em;
    font-weight: normal;
    color: #bcd0f7;
    opacity: 0.9;
    margin-top: 2px;                    /* ì œëª©ê³¼ì˜ ì—¬ë°± ìµœì†Œí™” */
    display: block;                     /* ì¤„ë°”ê¿ˆ í™•ì‹¤íˆ ì ìš© */
  }
  
  .date-container {
    text-align: right;
    line-height: 1.2;
  }

  .version {
    font-size: 24px;
    color: #bcd0f7;
    opacity: 0.9;
  }

  .date-header {
    font-size: 16px;
    color: #fff;
    margin: 0;
  }

  .container {
    background:#fff; border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,0.08);
    margin:30px; padding:4px 32px;
  }
  textarea {
    width:97%; min-height:120px; border:1px solid #d1d5db; border-radius:8px;
    padding:10px; resize:vertical; background:#fafafa; font-family:Consolas,monospace;
  }
  textarea:focus { outline:none; border-color:#2563eb; background:#fff; box-shadow:0 0 0 2px rgba(37,99,235,0.2); }
  button {
    background:#2563eb; color:white; border:none; border-radius:8px;
    padding:9px 16px; cursor:pointer; font-weight:600; margin-top:10px;
  }
  button:hover { background:#1e40af; }

  pre {
    background:#0f172a; color:#e2e8f0; padding:12px; border-radius:10px;
    white-space:pre-line;
    overflow-x:auto;
    line-height:1.1;
    margin:10;
    min-height:100px;
  }

  .match-line { color:#67C090; }
  .na-line { color:#7f1d1d; }
  .blue-line { color:#3b82f6; }
  .pink-line { color:#ec4899; }
  .url-line { color:#facc15; }
  .purple-line { color:#a855f7; } /* verdict ì¤„ - ë³´ë¼ìƒ‰ */

  .session-list {
    margin-top:15px; border:1px solid #d1d5db; border-radius:8px;
    max-height:400px; overflow-y:auto; background:#f9fafb;
  }
  .session-item {
    padding:8px 12px; border-bottom:1px solid #e5e7eb; cursor:pointer;
    font-family:Consolas, monospace;
  }
  .session-item:hover { background:#e0f2fe; }
  .session-id { font-weight:bold; color:#111827; display:block; }
  .session-method { color:#2563eb; font-weight:600; }
  .session-url { color:#7c3aed; }
  .active-session { background:#dbeafe; }

  .filter-box {
    margin-top: 15px; padding: 8px; background: #f3f4f6;
    border-radius: 8px; display: flex; gap: 18px; align-items: center;
  }
  .warning { color:#b91c1c; font-size:13px; margin-left:auto; }
  
  body {
    font-family: "Segoe UI", Arial, sans-serif;
    background: #f3f4f6;
    margin: 0;
    padding: 40px;
  }


  textarea.dragover {
    border: 2px dashed #2563eb !important;
    background: #eef2ff !important;
  }


</style>
</head>
<body>

<div class="top-nav">
  <a href="https://etech-symantec.github.io/sysinfo" class="nav-btn">ğŸ§© Sysinfo ë¶„ì„</a>
  <a href="https://etech-symantec.github.io/trace" class="nav-btn">ğŸ“„ Trace ë¶„ì„</a>
</div>

<h1 class="dongle-regular">
  <div class="title-left">ProxySG Trace ë¶„ì„ ë„êµ¬<br><span class="subtitle">by ì´í…Œí¬ì‹œìŠ¤í…œ</span></div>
  <div class="date-container">
    <div class="version">ver.2025.10.31.01</div><p>
    <div></div>
  </div>
</h1>

<div class="container">
  <h2>ğŸ“„ Trace ì…ë ¥</h2>
  <textarea id="inputText" placeholder="ì—¬ê¸°ì— trace ë¡œê·¸ë¥¼ ë¶™ì—¬ë„£ê±°ë‚˜ íŒŒì¼ì„ ëŒì–´ ë†“ìœ¼ì„¸ìš”."></textarea>
  <input type="file" id="fileInput" accept=".txt" style="margin-top:8px;">
  <br>
  <button id="analyzeBtn">ğŸ” ë¶„ì„ ì‹¤í–‰</button>
  <button id="downloadBtn">ğŸ’¾ ê²°ê³¼ HTMLë¡œ ì €ì¥</button>

  <div id="sessionSelectorContainer" style="display:none;">
    <label><b>ì„¸ì…˜ ì„ íƒ:</b></label>
    <div class="session-list" id="sessionList"></div>
  </div>

  <div class="filter-box" id="filterBox" style="display:none;">
    <label><input type="checkbox" id="showMiss"> miss ë³´ê¸° (<span id="missCount">0</span>)</label>
    <label><input type="checkbox" id="showNA"> n/a ë³´ê¸° (<span id="naCount">0</span>)</label>
    <span class="warning" id="perfWarning" style="display:none;">âš ï¸ 1000ê°œ ì´ìƒ í•­ëª©ì€ ë Œë”ë§ì´ ëŠë ¤ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤</span>
  </div>

  <h2 style="margin-top:25px;">ğŸ§© ë¶„ì„ ê²°ê³¼</h2>
  <pre id="result">(ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤)</pre>
</div>

<script>
// === íŒŒì¼ ì„ íƒ ë²„íŠ¼ ì—…ë¡œë“œ ===
document.getElementById("fileInput").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    document.getElementById("inputText").value = ev.target.result;
    // âœ… íŒŒì¼ ë¡œë“œ í›„ ìë™ ë¶„ì„ ì‹¤í–‰
    document.getElementById("analyzeBtn").click();
  };
  reader.readAsText(file);
});

function htmlEscape(str) {
  return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
}

let sessions = [];

document.getElementById("analyzeBtn").addEventListener("click", () => {
  const text = document.getElementById("inputText").value;
  if (!text.trim()) {
    alert("í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.");
    return;
  }

  const pattern = /start transaction[\s\S]*?stop transaction/gi;
  const matches = text.match(pattern);
  if (!matches) {
    document.getElementById("result").textContent = "ë¶„ì„í•  íŠ¸ëœì­ì…˜ êµ¬ê°„ì´ ì—†ìŠµë‹ˆë‹¤.";
    return;
  }

  sessions = [];
  let totalMiss = 0;
  let totalNA = 0;

  matches.forEach(block => {
    const lines = block.split(/\r?\n+/).map(l => l.trim()).filter(Boolean);
    let sessionHeader = "Unknown";
    if (lines.length > 1 && /^transaction/i.test(lines[1])) {
      sessionHeader = lines[1].replace(/^start\s+/i, "").trim();
    }

    let urlLine = "ì •ë³´ ì—†ìŒ";
    const timeIdx = lines.findIndex(line => /^time\s*:/i.test(line));
    if (timeIdx !== -1 && lines[timeIdx + 1]) {
      const nextLine = lines[timeIdx + 1].trim();
      if (/^(CONNECT|GET|POST|PUT|DELETE|HEAD|OPTIONS|unknown|ssl|tcp|tls)\s+/i.test(nextLine)) {
        urlLine = nextLine;
      }
    }

    let methodPart = "", urlPart = "";
    const urlParts = urlLine.split(/\s+/);
    if (urlParts.length >= 2) {
      methodPart = urlParts[0];
      urlPart = urlParts.slice(1).join(" ");
    }

    const allLines = [];
    let sectionLineNum = 0;
    let currentSection = null;

    for (let i = 0; i < lines.length; i++) {
      let line = lines[i];
      if (/^start transaction/i.test(line) || /^stop transaction/i.test(line)) continue;

      // === <...> ì„¹ì…˜ êµ¬ë¶„ì„  í‘œì‹œ ===
      const sectionMatch = line.match(/^<([A-Za-z0-9_\-\s"'\@\:\"\[\]\:]+)>/);
      if (sectionMatch) {
        const sectionName = sectionMatch[1];

        // â‘  ë‚´ë¶€ ì°¸ì¡° ì •ì±… (@ í¬í•¨)
        if (/@/.test(sectionName)) {
          const prevLine = lines[i - 1] || "";

          // â–¶ ì²˜ìŒ ë“±ì¥í•˜ëŠ” @ ì„¹ì…˜ì´ë©´ êµ¬ë¶„ì„  ì¶”ê°€
          if (!lines.slice(0, i).some(l => /^<[^>]*@/.test(l))) {
            allLines.push({
              type: "normal",
              content: `<span style="color:#a1a1a1;"><br>â”€â”€â”€[ ë‚´ë¶€ ì°¸ì¡° ì •ì±… ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>`
            });
          }

          // ë³¸ë¬¸ ì¶œë ¥
          allLines.push({
            type: "normal", content: htmlEscape(line) });
          continue;
        }

        // â‘¡ Local ì •ì±… ([local:] í¬í•¨)
        if (/\[local:/i.test(line)) {
          const alreadyLocal = allLines.some(l => l.content?.includes("â”€â”€â”€[ Local ì •ì±… ]"));
          if (!alreadyLocal) {
            allLines.push({
              type: "normal",
              content: `<span style="color:#F49BAB;"><br>â”€â”€â”€[ Local ì •ì±… ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>`
            });
          }
          allLines.push({
            type: "normal", content: htmlEscape(line)});
          continue;
        }

        // â‘¢ VPM ì •ì±… (@ ì—†ìŒ, [local:] ì—†ìŒ)
        const prevHasAt = lines.slice(0, i).some(l => /^<[^>]*@/.test(l));
        const alreadyVPM = allLines.some(l => l.content?.includes("â”€â”€â”€[ VPM ì •ì±… ]"));
        if (prevHasAt && !alreadyVPM) {
          allLines.push({
            type: "normal",
            content: `<span style="color:#77BEF0;"><br>â”€â”€â”€[ VPM ì •ì±… ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>`
          });
        }

        // ë³¸ë¬¸ ì¶œë ¥
        currentSection = sectionName;
        sectionLineNum = 0;
        allLines.push({
          type: "normal", content: htmlEscape(line) });
        continue;
      }


      if (currentSection) sectionLineNum++;

      
      // condition ë˜ëŠ” Assigned values ~ connection ì „ê¹Œì§€ ì‚­ì œ (connection ì¤„ì€ ë³´ì¡´)
      if (
        /^Matched condition definitions:/i.test(line) ||
        /^Assigned values of transaction variables:/i.test(line)
      ) {
        while (i + 1 < lines.length) {
          // ë‹¤ìŒ ì¤„ì´ connection:ì´ë©´ ì‚­ì œ ì¤‘ë‹¨í•˜ê³  ë‚¨ê¹€
          if (/^connection:/i.test(lines[i + 1])) {
            break;
          }
          i++;
        }
        continue;
      }


      // connection: êµ¬ë¶„ì„  + ë³¸ë¬¸ ì¶œë ¥
      if (/^connection:/i.test(line)) {
        allLines.push({
          type: "normal",
          content: `<span style="color:#E9D484;"><br>===[ Connection Info ]===================================================================================================</span>`
        });
        allLines.push({ type: "normal", content: `<span style="color:#E9D484;">${htmlEscape(line)}</span>`
        });
        continue;
      }
      
      // verdict: êµ¬ë¶„ì„  + ë³¸ë¬¸ ì¶œë ¥
      if (/^verdict:/i.test(line)) {
        allLines.push({
          type: "normal",
          content: `<span style="color:#B7A3E3;"><br>===[ Verdict ]==========================================================================================================</span>`
        });
        allLines.push({ type: "normal", content: `<span style="color:#B7A3E3;">${htmlEscape(line)}</span>`
        });
        continue;
      }
      
      // Transaction timing êµ¬ë¶„ì„  + ë³¸ë¬¸ ì¶œë ¥
      if (/^Transaction timing:/i.test(line)) {
        allLines.push({
          type: "normal",
          content: `<span style="color:#FFD5D5;"><br>===[ Transaction Timing ]===============================================================================================</span>`
        });
        allLines.push({ type: "normal", content: `<span style="color:#FFD5D5;">${htmlEscape(line)}</span>`
        });
        continue;
      }




      if (/^miss:/i.test(line)) {
        totalMiss++;
        allLines.push({ type: "miss", content: `<span class="blue-line">${htmlEscape(line)}</span>` });
        continue;
      }

      if (/^n\/a/i.test(line)) {
        totalNA++;
        allLines.push({ type: "na", content: `<span class="na-line">${htmlEscape(line)}</span>` });
        continue;
      }

      // MATCH: < ë¡œ ì‹œì‘í•˜ë©´ MATCH: ì œê±°
      if (/^\s*MATCH:\s*</i.test(line)) {
        line = line.replace(/^MATCH:\s*/i, "");
      }

      // === [1ï¸âƒ£ MATCH: < ë¡œ ì‹œì‘í•˜ë©´ ë¨¼ì € ì œê±°] ===
      if (/^\s*MATCH:\s*</i.test(line)) {
        line = line.replace(/^MATCH:\s*/i, "");
      }

      // === [2ï¸âƒ£ ì„¹ì…˜ ê¸°ì¤€ì  ê°ì§€] ===
      // '<' ë˜ëŠ” 'MATCH: <'ë¡œ ì‹œì‘í–ˆë˜ ëª¨ë“  ì¤„ì„ ì„¹ì…˜ ê¸°ì¤€ìœ¼ë¡œ ì²˜ë¦¬
      const sectionStartPattern = /^<|^\s*MATCH:\s*</i;
      if (sectionStartPattern.test(lines[i])) {
        currentSection = "section_" + i;  // ê³ ìœ í•œ ì„¹ì…˜ ì‹ë³„ìš© ì´ë¦„
        sectionLineNum = 0;
      }

      // === [3ï¸âƒ£ MATCH ì¹´ìš´íŠ¸ ê³„ì‚°: ë°”ë¡œ ìœ„ ì„¹ì…˜ë¶€í„°ì˜ ìƒëŒ€ ìœ„ì¹˜]
      if (/^MATCH:/i.test(line)) {
        let relativeIndex = 1;
        for (let j = i - 1; j >= 0; j--) {
          // '<' í˜¹ì€ 'MATCH: <' ë§Œë‚˜ëŠ” ìˆœê°„ ì¤‘ë‹¨
          if (/^<|^\s*MATCH:\s*</i.test(lines[j])) break;
          relativeIndex++;
        }
        line = `ã€€(#${relativeIndex}) ${line}`;
      }


      line = htmlEscape(line);
      if (/^\ã€€\(\#\d+\)\s*MATCH:/i.test(line)) line = `<span class="match-line">${line}</span>`;
      else if (/^(client-in:|server-out:)/i.test(line)) line = `<span class="blue-line">${line}</span>`;
      else if (/^(server-in:|client-out:)/i.test(line)) line = `<span class="pink-line">${line}</span>`;
      else if (/^(CONNECT|GET|POST|PUT|DELETE|HEAD|OPTIONS|unknown|ssl|tcp|tls)\s+/i.test(line))
        line = `<span class="url-line">${line}</span>`;

      allLines.push({ type: "normal", content: line });
    }

    sessions.push({ id: sessionHeader, methodPart, urlPart, lines: allLines });
  });

  // miss/n/a ì¹´ìš´íŠ¸ ë°˜ì˜
  document.getElementById("missCount").textContent = totalMiss;
  document.getElementById("naCount").textContent = totalNA;

  const perfWarn = document.getElementById("perfWarning");
  if (totalMiss + totalNA > 1000) perfWarn.style.display = "inline";
  else perfWarn.style.display = "none";

  const listContainer = document.getElementById("sessionList");
  listContainer.innerHTML = "";
  document.getElementById("sessionSelectorContainer").style.display = "block";
  document.getElementById("filterBox").style.display = "flex";

  sessions.forEach((s, idx) => {
    const div = document.createElement("div");
    div.className = "session-item";
    div.innerHTML = `
      <span class="session-id">${s.id}</span>
      <span class="session-method">${s.methodPart}</span>
      <span class="session-url">${s.urlPart}</span>
    `;
    div.addEventListener("click", () => {
      document.querySelectorAll(".session-item").forEach(el => el.classList.remove("active-session"));
      div.classList.add("active-session");
      renderSession(idx);
    });
    listContainer.appendChild(div);
  });

  document.querySelectorAll(".session-item")[0].classList.add("active-session");
  renderSession(0);
});

function renderSession(index) {
  const s = sessions[index];
  const showMiss = document.getElementById("showMiss").checked;
  const showNA = document.getElementById("showNA").checked;

  const visibleLines = s.lines
    .filter(l => {
      if (l.type === "miss" && !showMiss) return false;
      if (l.type === "na" && !showNA) return false;
      return true;
    })
    .map(l => l.content)
    .join("\n")
    .replace(/\n{2,}/g, "\n")
    .trim();

  document.getElementById("result").innerHTML = visibleLines;
}

document.getElementById("showMiss").addEventListener("change", () => {
  const idx = [...document.querySelectorAll(".session-item")].findIndex(el => el.classList.contains("active-session"));
  renderSession(idx);
});
document.getElementById("showNA").addEventListener("change", () => {
  const idx = [...document.querySelectorAll(".session-item")].findIndex(el => el.classList.contains("active-session"));
  renderSession(idx);
});

document.getElementById("downloadBtn").addEventListener("click", () => {
  const html = document.documentElement.outerHTML;
  const blob = new Blob([html], { type: "text/html" });
  const a = document.createElement("a");
  const date = new Date().toISOString().slice(0,10).replace(/-/g,"");
  a.href = URL.createObjectURL(blob);
  a.download = `Trace_Report_${date}.html`;
  a.click();
  URL.revokeObjectURL(a.href);
});


// === ë“œë˜ê·¸ ì•¤ ë“œë¡­ íŒŒì¼ ì—…ë¡œë“œ ê¸°ëŠ¥ ===
const inputArea = document.getElementById("inputText");

inputArea.addEventListener("dragover", (e) => {
  e.preventDefault();
  inputArea.style.borderColor = "#2563eb";
  inputArea.style.background = "#eef2ff";
});

inputArea.addEventListener("dragleave", () => {
  inputArea.style.borderColor = "#d1d5db";
  inputArea.style.background = "#fafafa";
});

inputArea.addEventListener("drop", (e) => {
  e.preventDefault();
  inputArea.style.borderColor = "#d1d5db";
  inputArea.style.background = "#fafafa";

  const file = e.dataTransfer.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (ev) => {
    inputArea.value = ev.target.result;
    // âœ… íŒŒì¼ ë“œë¡­ í›„ ìë™ ë¶„ì„ ì‹¤í–‰
    document.getElementById("analyzeBtn").click();
  };
  reader.readAsText(file);
});


</script>

</body>
</html>
