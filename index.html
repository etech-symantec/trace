<!DOCTYPE html>
<html lang="ko">
<head>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Dongle&display=swap" rel="stylesheet">
<meta charset="UTF-8">
<title>ProxySG Trace 분석 도구</title>
<style>
  body { font-family:"Segoe UI", Arial, sans-serif; background:#f5f7fa; margin:20px; color:#333; }
  .dongle-regular {
    font-family: "Dongle", sans-serif;
    font-weight: 400;
    font-style: normal;
  }

  /* 🔹 상단 네비게이션 버튼 */
  .top-nav {
    display: flex;
    justify-content: flex-end;
    gap: 5px;
    margin-bottom: 5px;
  }

  .nav-btn {
    background: #1e3a5f;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 4px 10px;       /* 좌우 여백 살짝 확보 */
    height: 18px;            /* 버튼 높이 고정 */
    line-height: 18px;       /* 텍스트를 세로 중앙으로 정렬 */
    cursor: pointer;
    font-weight: 600;
    font-size: 0.75rem;         /* 폰트 크기 절반 수준 */
    text-decoration: none;
    transition: background 0.2s;
  }

  .nav-btn:hover {
    background: #294b7a;
  }


  h1 {
  	font-size: 1.5em;
    background: #1e3a5f;
    color: white;
    padding: 12px 18px;
    border-radius: 8px;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    margin-bottom: 5pt;
  }

  .title-left {
    font-size: 1.6em;                   /* 제목 크게 */
    line-height: 0.7;                   /* 줄 간격 줄이기 */
    margin-bottom: 0;                   /* 아래 여백 제거 */
  }

  .subtitle {
    font-size: 0.7em;
    font-weight: normal;
    color: #bcd0f7;
    opacity: 0.9;
    margin-top: 2px;                    /* 제목과의 여백 최소화 */
    display: block;                     /* 줄바꿈 확실히 적용 */
  }
  
  .date-container {
    text-align: right;
    line-height: 1.2;
  }

  .version {
    font-size: 24px;
    color: #bcd0f7;
    opacity: 0.9;
  }

  .date-header {
    font-size: 16px;
    color: #fff;
    margin: 0;
  }

  .container {
    background:#fff; border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,0.08);
    margin:30px; padding:4px 32px;
  }
  textarea {
    width:97%; min-height:120px; border:1px solid #d1d5db; border-radius:8px;
    padding:10px; resize:vertical; background:#fafafa; font-family:Consolas,monospace;
  }
  textarea:focus { outline:none; border-color:#2563eb; background:#fff; box-shadow:0 0 0 2px rgba(37,99,235,0.2); }
  button {
    background:#2563eb; color:white; border:none; border-radius:8px;
    padding:9px 16px; cursor:pointer; font-weight:600; margin-top:10px;
  }
  button:hover { background:#1e40af; }

  pre {
    background:#0f172a; color:#e2e8f0; padding:12px; border-radius:10px;
    white-space:pre-line;
    overflow-x:auto;
    line-height:1.1;
    margin:10;
    min-height:100px;
  }

  .match-line { color:#67C090; }
  .na-line { color:#7f1d1d; }
  .blue-line { color:#3b82f6; }
  .pink-line { color:#ec4899; }
  .url-line { color:#facc15; }
  .purple-line { color:#a855f7; } /* verdict 줄 - 보라색 */

  .session-list {
    margin-top:15px; border:1px solid #d1d5db; border-radius:8px;
    max-height:400px; overflow-y:auto; background:#f9fafb;
  }
  .session-item {
    padding:8px 12px; border-bottom:1px solid #e5e7eb; cursor:pointer;
    font-family:Consolas, monospace;
  }
  .session-item:hover { background:#e0f2fe; }
  .session-id { font-weight:bold; color:#111827; display:block; }
  .session-method { color:#2563eb; font-weight:600; }
  .session-url { color:#7c3aed; }
  .active-session { background:#dbeafe; }

  .filter-box {
    margin-top: 15px; padding: 8px; background: #f3f4f6;
    border-radius: 8px; display: flex; gap: 18px; align-items: center;
  }
  .warning { color:#b91c1c; font-size:13px; margin-left:auto; }
  
  body {
    font-family: "Segoe UI", Arial, sans-serif;
    background: #f3f4f6;
    margin: 0;
    padding: 40px;
  }


  textarea.dragover {
    border: 2px dashed #2563eb !important;
    background: #eef2ff !important;
  }


</style>
</head>
<body>

<div class="top-nav">
  <a href="https://etech-symantec.github.io/sysinfo" class="nav-btn">🧩 Sysinfo 분석</a>
  <a href="https://etech-symantec.github.io/trace" class="nav-btn">📄 Trace 분석</a>
</div>

<h1 class="dongle-regular">
  <div class="title-left">ProxySG Trace 분석 도구<br><span class="subtitle">by 이테크시스템</span></div>
  <div class="date-container">
    <div class="version">ver.2025.10.31.01</div><p>
    <div></div>
  </div>
</h1>

<div class="container">
  <h2>📄 Trace 입력</h2>
  <textarea id="inputText" placeholder="여기에 trace 로그를 붙여넣거나 파일을 끌어 놓으세요."></textarea>
  <input type="file" id="fileInput" accept=".txt" style="margin-top:8px;">
  <br>
  <button id="analyzeBtn">🔍 분석 실행</button>
  <button id="downloadBtn">💾 결과 HTML로 저장</button>

  <div id="sessionSelectorContainer" style="display:none;">
    <label><b>세션 선택:</b></label>
    <div class="session-list" id="sessionList"></div>
  </div>

  <div class="filter-box" id="filterBox" style="display:none;">
    <label><input type="checkbox" id="showMiss"> miss 보기 (<span id="missCount">0</span>)</label>
    <label><input type="checkbox" id="showNA"> n/a 보기 (<span id="naCount">0</span>)</label>
    <span class="warning" id="perfWarning" style="display:none;">⚠️ 1000개 이상 항목은 렌더링이 느려질 수 있습니다</span>
  </div>

  <h2 style="margin-top:25px;">🧩 분석 결과</h2>
  <pre id="result">(분석 결과가 여기에 표시됩니다)</pre>
</div>

<script>
// === 파일 선택 버튼 업로드 ===
document.getElementById("fileInput").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    document.getElementById("inputText").value = ev.target.result;
    // ✅ 파일 로드 후 자동 분석 실행
    document.getElementById("analyzeBtn").click();
  };
  reader.readAsText(file);
});

function htmlEscape(str) {
  return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
}

let sessions = [];

document.getElementById("analyzeBtn").addEventListener("click", () => {
  const text = document.getElementById("inputText").value;
  if (!text.trim()) {
    alert("텍스트를 입력하거나 파일을 업로드하세요.");
    return;
  }

  const pattern = /start transaction[\s\S]*?stop transaction/gi;
  const matches = text.match(pattern);
  if (!matches) {
    document.getElementById("result").textContent = "분석할 트랜잭션 구간이 없습니다.";
    return;
  }

  sessions = [];
  let totalMiss = 0;
  let totalNA = 0;

  matches.forEach(block => {
    const lines = block.split(/\r?\n+/).map(l => l.trim()).filter(Boolean);
    let sessionHeader = "Unknown";
    if (lines.length > 1 && /^transaction/i.test(lines[1])) {
      sessionHeader = lines[1].replace(/^start\s+/i, "").trim();
    }

    let urlLine = "정보 없음";
    const timeIdx = lines.findIndex(line => /^time\s*:/i.test(line));
    if (timeIdx !== -1 && lines[timeIdx + 1]) {
      const nextLine = lines[timeIdx + 1].trim();
      if (/^(CONNECT|GET|POST|PUT|DELETE|HEAD|OPTIONS|unknown|ssl|tcp|tls)\s+/i.test(nextLine)) {
        urlLine = nextLine;
      }
    }

    let methodPart = "", urlPart = "";
    const urlParts = urlLine.split(/\s+/);
    if (urlParts.length >= 2) {
      methodPart = urlParts[0];
      urlPart = urlParts.slice(1).join(" ");
    }

    const allLines = [];
    let sectionLineNum = 0;
    let currentSection = null;

    for (let i = 0; i < lines.length; i++) {
      let line = lines[i];
      if (/^start transaction/i.test(line) || /^stop transaction/i.test(line)) continue;

      // === <...> 섹션 구분선 표시 ===
      const sectionMatch = line.match(/^<([A-Za-z0-9_\-\s"'\@\:\"\[\]\:]+)>/);
      if (sectionMatch) {
        const sectionName = sectionMatch[1];

        // ① 내부 참조 정책 (@ 포함)
        if (/@/.test(sectionName)) {
          const prevLine = lines[i - 1] || "";

          // ▶ 처음 등장하는 @ 섹션이면 구분선 추가
          if (!lines.slice(0, i).some(l => /^<[^>]*@/.test(l))) {
            allLines.push({
              type: "normal",
              content: `<span style="color:#a1a1a1;"><br>───[ 내부 참조 정책 ]────────────────────────────────────────────────</span>`
            });
          }

          // 본문 출력
          allLines.push({
            type: "normal", content: htmlEscape(line) });
          continue;
        }

        // ② Local 정책 ([local:] 포함)
        if (/\[local:/i.test(line)) {
          const alreadyLocal = allLines.some(l => l.content?.includes("───[ Local 정책 ]"));
          if (!alreadyLocal) {
            allLines.push({
              type: "normal",
              content: `<span style="color:#F49BAB;"><br>───[ Local 정책 ]──────────────────────────────────────────────────</span>`
            });
          }
          allLines.push({
            type: "normal", content: htmlEscape(line)});
          continue;
        }

        // ③ VPM 정책 (@ 없음, [local:] 없음)
        const prevHasAt = lines.slice(0, i).some(l => /^<[^>]*@/.test(l));
        const alreadyVPM = allLines.some(l => l.content?.includes("───[ VPM 정책 ]"));
        if (prevHasAt && !alreadyVPM) {
          allLines.push({
            type: "normal",
            content: `<span style="color:#77BEF0;"><br>───[ VPM 정책 ]──────────────────────────────────────────────────</span>`
          });
        }

        // 본문 출력
        currentSection = sectionName;
        sectionLineNum = 0;
        allLines.push({
          type: "normal", content: htmlEscape(line) });
        continue;
      }


      if (currentSection) sectionLineNum++;

      
      // condition 또는 Assigned values ~ connection 전까지 삭제 (connection 줄은 보존)
      if (
        /^Matched condition definitions:/i.test(line) ||
        /^Assigned values of transaction variables:/i.test(line)
      ) {
        while (i + 1 < lines.length) {
          // 다음 줄이 connection:이면 삭제 중단하고 남김
          if (/^connection:/i.test(lines[i + 1])) {
            break;
          }
          i++;
        }
        continue;
      }


      // connection: 구분선 + 본문 출력
      if (/^connection:/i.test(line)) {
        allLines.push({
          type: "normal",
          content: `<span style="color:#E9D484;"><br>===[ Connection Info ]===================================================================================================</span>`
        });
        allLines.push({ type: "normal", content: `<span style="color:#E9D484;">${htmlEscape(line)}</span>`
        });
        continue;
      }
      
      // verdict: 구분선 + 본문 출력
      if (/^verdict:/i.test(line)) {
        allLines.push({
          type: "normal",
          content: `<span style="color:#B7A3E3;"><br>===[ Verdict ]==========================================================================================================</span>`
        });
        allLines.push({ type: "normal", content: `<span style="color:#B7A3E3;">${htmlEscape(line)}</span>`
        });
        continue;
      }
      
      // Transaction timing 구분선 + 본문 출력
      if (/^Transaction timing:/i.test(line)) {
        allLines.push({
          type: "normal",
          content: `<span style="color:#FFD5D5;"><br>===[ Transaction Timing ]===============================================================================================</span>`
        });
        allLines.push({ type: "normal", content: `<span style="color:#FFD5D5;">${htmlEscape(line)}</span>`
        });
        continue;
      }




      if (/^miss:/i.test(line)) {
        totalMiss++;
        allLines.push({ type: "miss", content: `<span class="blue-line">${htmlEscape(line)}</span>` });
        continue;
      }

      if (/^n\/a/i.test(line)) {
        totalNA++;
        allLines.push({ type: "na", content: `<span class="na-line">${htmlEscape(line)}</span>` });
        continue;
      }

      // MATCH: < 로 시작하면 MATCH: 제거
      if (/^\s*MATCH:\s*</i.test(line)) {
        line = line.replace(/^MATCH:\s*/i, "");
      }

      // === [1️⃣ MATCH: < 로 시작하면 먼저 제거] ===
      if (/^\s*MATCH:\s*</i.test(line)) {
        line = line.replace(/^MATCH:\s*/i, "");
      }

      // === [2️⃣ 섹션 기준점 감지] ===
      // '<' 또는 'MATCH: <'로 시작했던 모든 줄을 섹션 기준으로 처리
      const sectionStartPattern = /^<|^\s*MATCH:\s*</i;
      if (sectionStartPattern.test(lines[i])) {
        currentSection = "section_" + i;  // 고유한 섹션 식별용 이름
        sectionLineNum = 0;
      }

      // === [3️⃣ MATCH 카운트 계산: 바로 위 섹션부터의 상대 위치]
      if (/^MATCH:/i.test(line)) {
        let relativeIndex = 1;
        for (let j = i - 1; j >= 0; j--) {
          // '<' 혹은 'MATCH: <' 만나는 순간 중단
          if (/^<|^\s*MATCH:\s*</i.test(lines[j])) break;
          relativeIndex++;
        }
        line = `　(#${relativeIndex}) ${line}`;
      }


      line = htmlEscape(line);
      if (/^\　\(\#\d+\)\s*MATCH:/i.test(line)) line = `<span class="match-line">${line}</span>`;
      else if (/^(client-in:|server-out:)/i.test(line)) line = `<span class="blue-line">${line}</span>`;
      else if (/^(server-in:|client-out:)/i.test(line)) line = `<span class="pink-line">${line}</span>`;
      else if (/^(CONNECT|GET|POST|PUT|DELETE|HEAD|OPTIONS|unknown|ssl|tcp|tls)\s+/i.test(line))
        line = `<span class="url-line">${line}</span>`;

      allLines.push({ type: "normal", content: line });
    }

    sessions.push({ id: sessionHeader, methodPart, urlPart, lines: allLines });
  });

  // miss/n/a 카운트 반영
  document.getElementById("missCount").textContent = totalMiss;
  document.getElementById("naCount").textContent = totalNA;

  const perfWarn = document.getElementById("perfWarning");
  if (totalMiss + totalNA > 1000) perfWarn.style.display = "inline";
  else perfWarn.style.display = "none";

  const listContainer = document.getElementById("sessionList");
  listContainer.innerHTML = "";
  document.getElementById("sessionSelectorContainer").style.display = "block";
  document.getElementById("filterBox").style.display = "flex";

  sessions.forEach((s, idx) => {
    const div = document.createElement("div");
    div.className = "session-item";
    div.innerHTML = `
      <span class="session-id">${s.id}</span>
      <span class="session-method">${s.methodPart}</span>
      <span class="session-url">${s.urlPart}</span>
    `;
    div.addEventListener("click", () => {
      document.querySelectorAll(".session-item").forEach(el => el.classList.remove("active-session"));
      div.classList.add("active-session");
      renderSession(idx);
    });
    listContainer.appendChild(div);
  });

  document.querySelectorAll(".session-item")[0].classList.add("active-session");
  renderSession(0);
});

function renderSession(index) {
  const s = sessions[index];
  const showMiss = document.getElementById("showMiss").checked;
  const showNA = document.getElementById("showNA").checked;

  const visibleLines = s.lines
    .filter(l => {
      if (l.type === "miss" && !showMiss) return false;
      if (l.type === "na" && !showNA) return false;
      return true;
    })
    .map(l => l.content)
    .join("\n")
    .replace(/\n{2,}/g, "\n")
    .trim();

  document.getElementById("result").innerHTML = visibleLines;
}

document.getElementById("showMiss").addEventListener("change", () => {
  const idx = [...document.querySelectorAll(".session-item")].findIndex(el => el.classList.contains("active-session"));
  renderSession(idx);
});
document.getElementById("showNA").addEventListener("change", () => {
  const idx = [...document.querySelectorAll(".session-item")].findIndex(el => el.classList.contains("active-session"));
  renderSession(idx);
});

document.getElementById("downloadBtn").addEventListener("click", () => {
  const html = document.documentElement.outerHTML;
  const blob = new Blob([html], { type: "text/html" });
  const a = document.createElement("a");
  const date = new Date().toISOString().slice(0,10).replace(/-/g,"");
  a.href = URL.createObjectURL(blob);
  a.download = `Trace_Report_${date}.html`;
  a.click();
  URL.revokeObjectURL(a.href);
});


// === 드래그 앤 드롭 파일 업로드 기능 ===
const inputArea = document.getElementById("inputText");

inputArea.addEventListener("dragover", (e) => {
  e.preventDefault();
  inputArea.style.borderColor = "#2563eb";
  inputArea.style.background = "#eef2ff";
});

inputArea.addEventListener("dragleave", () => {
  inputArea.style.borderColor = "#d1d5db";
  inputArea.style.background = "#fafafa";
});

inputArea.addEventListener("drop", (e) => {
  e.preventDefault();
  inputArea.style.borderColor = "#d1d5db";
  inputArea.style.background = "#fafafa";

  const file = e.dataTransfer.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (ev) => {
    inputArea.value = ev.target.result;
    // ✅ 파일 드롭 후 자동 분석 실행
    document.getElementById("analyzeBtn").click();
  };
  reader.readAsText(file);
});


</script>

</body>
</html>
