<!DOCTYPE html>
<html lang="ko">
<head>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Dongle&display=swap" rel="stylesheet">
<meta charset="UTF-8">
<title>ProxySG Trace ë¶„ì„ ë„êµ¬</title>
<style>
  body { font-family:"Segoe UI", Arial, sans-serif; background:#f5f7fa; margin:20px; color:#333; }
  
  .dongle-regular {
    font-family: "Dongle", sans-serif;
    font-weight: 400;
    font-style: normal;
  }

  /* ğŸ”¹ ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ */
  .top-nav {
    display: flex;
    justify-content: flex-end;
    gap: 5px;
    margin-bottom: -10px;
  }

  .nav-btn {
    background: #1e3a5f;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 4px 10px;       /* ì¢Œìš° ì—¬ë°± ì‚´ì§ í™•ë³´ */
    height: 18px;            /* ë²„íŠ¼ ë†’ì´ ê³ ì • */
    line-height: 18px;       /* í…ìŠ¤íŠ¸ë¥¼ ì„¸ë¡œ ì¤‘ì•™ìœ¼ë¡œ ì •ë ¬ */
    cursor: pointer;
    font-weight: 600;
    font-size: 0.75rem;         /* í°íŠ¸ í¬ê¸° ì ˆë°˜ ìˆ˜ì¤€ */
    text-decoration: none;
    transition: background 0.2s;
  }

  .nav-btn:hover {
    background: #294b7a;
  }

  h1 {
  	font-size: 1.5em;
    background: #1e3a5f;
    color: white;
    padding: 12px 18px;
    border-radius: 8px;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    margin-bottom: 5pt;
  }

  .title-left {
    font-size: 1.6em;                   /* ì œëª© í¬ê²Œ */
    line-height: 0.7;                   /* ì¤„ ê°„ê²© ì¤„ì´ê¸° */
    margin-bottom: 0;                   /* ì•„ë˜ ì—¬ë°± ì œê±° */
  }

  .subtitle {
    font-size: 0.7em;
    font-weight: normal;
    color: #bcd0f7;
    opacity: 0.9;
    margin-top: 2px;                    /* ì œëª©ê³¼ì˜ ì—¬ë°± ìµœì†Œí™” */
    display: block;                     /* ì¤„ë°”ê¿ˆ í™•ì‹¤íˆ ì ìš© */
  }
  
  .date-container {
    text-align: right;
    line-height: 1.2;
  }

  .version {
    font-size: 24px;
    color: #bcd0f7;
    opacity: 0.9;
  }

  .date-header {
    font-size: 16px;
    color: #fff;
    margin: 0;
  }

  .container {
    background:#fff; border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,0.08);
    margin:30px; padding:4px 32px;
  }
  
  textarea {
    width:95%; min-height:180px; border:1px solid #d1d5db; border-radius:8px;
    padding:10px; resize:vertical; background:#fafafa; font-family:Consolas,monospace;
  }
  
  textarea:focus { outline:none; border-color:#2563eb; background:#fff; box-shadow:0 0 0 2px rgba(37,99,235,0.2); }
  
  button {
    background:#2563eb; color:white; border:none; border-radius:8px;
    padding:9px 16px; cursor:pointer; font-weight:600; margin-top:10px;
  }
  
  button:hover { background:#1e40af; }

  pre {
    background:#0f172a; color:#e2e8f0; padding:12px; border-radius:10px;
    white-space:pre-line;
    overflow-x:auto;
    line-height:1.1;
    margin:10;
    min-height:100px;
  }

  .match-line { color:#67C090; }
  .miss-line { color:#9BB4C0; }
  .na-line { color:#7f1d1d; }
  .blue-line { color:#3b82f6; }
  .pink-line { color:#ec4899; }
  .url-line { color:#facc15; }
  .purple-line { color:#a855f7; }
  .late-line { color:#E1D0B3; }

  .session-list {
    margin-top:15px; border:1px solid #d1d5db; border-radius:8px;
    max-height:400px; overflow-y:auto; background:#f9fafb;
  }
  .session-item {
    padding:8px 12px; border-bottom:1px solid #e5e7eb; cursor:pointer;
    font-family:Consolas, monospace;
  }
  .session-item:hover { background:#e0f2fe; }
  .session-id { font-weight:bold; color:#111827; display:block; }
  .session-method { color:#2563eb; font-weight:600; }
  .session-url { color:#7c3aed; }
  .active-session { background:#dbeafe; }

  .filter-box {
    margin-top: 15px; padding: 8px; background: #f3f4f6;
    border-radius: 8px; display: flex; gap: 18px; align-items: center;
  }
  
  .warning { color:#b91c1c; font-size:13px; margin-left:auto; }
  
  body {
    font-family: "Segoe UI", Arial, sans-serif;
    background: #f3f4f6;
    margin: 0;
    padding: 20px 40px 40px 40px;
  }

  textarea.dragover {
    border: 2px dashed #2563eb !important;
    background: #eef2ff !important;
  }
  
  #tzOffset {
    font-family: "Segoe UI", sans-serif;
    font-size: 0.7rem;
    background: #fff;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 2px 8px;
    cursor: pointer;
  }
  
  #tzOffset:hover {
    border-color: #2563eb;
  }
  
  #sessionSearchInput:focus {
    border-color: #2563eb;
    background: #fff;
    box-shadow: 0 0 0 2px rgba(37,99,235,0.15);
    outline: none;
  }


</style>
</head>
<body>

<div class="top-nav">
  <a href="https://etech-symantec.github.io/sysinfo" class="nav-btn">ğŸ§© Sysinfo ë¶„ì„</a>
  <a href="https://etech-symantec.github.io/trace" class="nav-btn">ğŸ“„ Trace ë¶„ì„</a>
  <a href="https://etech-symantec.github.io/sizing-sg" class="nav-btn">ğŸ“Š Sizing-SG ë³´ê¸°</a>
</div>

<h1 class="dongle-regular">
  <div class="title-left">ProxySG Trace ë¶„ì„ ë„êµ¬<br><span class="subtitle">by ì´í…Œí¬ì‹œìŠ¤í…œ</span></div>
  <div class="date-container">
    <div class="version">ver.2025.11.4.01</div><p>
    <div></div>
  </div>
</h1>


<div class="container">
  <h2 style="
    display: flex;
    align-items: baseline;
    gap: 8px;
    margin-bottom: 6px;   /* ğŸ‘ˆ ì•„ë˜ ì—¬ë°±ì„ ì¤„ì„ (ê¸°ë³¸ì€ 16px~20px ìˆ˜ì¤€) */
    margin-top: 14px;       /* ğŸ‘ˆ ìœ„ìª½ ì—¬ë°±ë„ ì‚´ì§ ì¤„ì„ */
  ">
    ğŸ“„ Trace ì…ë ¥
    <span id="fileNameDisplay" 
          style="font-size: 0.85rem; color: #6b7280; font-weight: 400;">
      (ì„ íƒëœ íŒŒì¼ ì—†ìŒ)
    </span>
  </h2>




  <div style="display:flex; gap:20px; align-items:flex-start;">

    <!-- ğŸ”¹ ì™¼ìª½: Trace ì…ë ¥ì°½ -->
    <div style="flex:1;">
      <textarea id="inputText" placeholder="ì—¬ê¸°ì— trace ë¡œê·¸ë¥¼ ë¶™ì—¬ë„£ê±°ë‚˜ íŒŒì¼ì„ ëŒì–´ ë†“ìœ¼ì„¸ìš”."></textarea>
    </div>

    <!-- ğŸ”¹ ì˜¤ë¥¸ìª½: ì¹´ë“œí˜• ë¶„ì„ ë„êµ¬ -->
    <div style="
      width: 25%;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    ">
      <h3 style="
        font-size: 1.1rem;
        margin: 0;
        margin-bottom: 8px;
        color: #1e3a5f;
        display: flex;
        align-items: center;
        gap: 6px;
      ">
        ğŸ“¦ ë¶„ì„ ë„êµ¬
      </h3>

      <input type="file" id="fileInput" accept=".txt" style="
        padding: 6px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        background:#f9fafb;
        cursor:pointer;
      ">

      <button id="analyzeBtn" style="
        background:#2563eb;
        color:white;
        border:none;
        border-radius:8px;
        padding:9px 16px;
        cursor:pointer;
        font-weight:600;
        transition: background 0.2s;
      ">ğŸ” ë¶„ì„ ì‹¤í–‰</button>

      <button id="downloadBtn" style="
        background:#10b981;
        color:white;
        border:none;
        border-radius:8px;
        padding:9px 16px;
        cursor:pointer;
        font-weight:600;
        transition: background 0.2s;
      ">ğŸ’¾ ê²°ê³¼ HTMLë¡œ ì €ì¥</button>
    </div>

  </div>



  <div id="sessionSelectorContainer" style="display:none; margin-top:10px; margin-bottom:8px;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
      <label style="white-space:nowrap; font-weight:400;"><b>ì„¸ì…˜ ì„ íƒ:</b></label>

      <!-- ğŸ” ê²€ìƒ‰ ì…ë ¥ì°½ -->
      <input 
        type="text" 
        id="sessionSearchInput" 
        placeholder="í‚¤ì›Œë“œë¡œ ê²€ìƒ‰ (ì˜ˆ: GET, URL, ID ë“±)" 
        style="
          flex:1;
          padding: 6px 10px;
          border: 1px solid #d1d5db;
          border-radius: 6px;
          font-family: 'Segoe UI', sans-serif;
          font-size: 0.9rem;
          box-sizing: border-box;
        ">
    </div>

    <!-- ğŸ”¹ ì„¸ì…˜ ëª©ë¡ -->
    <div class="session-list" id="sessionList" style="margin-top:8px;"></div>
  </div>


  <div class="filter-box" id="filterBox" style="display:none;">
    <div style="display:flex; align-items:center; gap:15px; flex:1;">
      <label><input type="checkbox" id="showMiss"> miss ë³´ê¸° (<span id="missCount">0</span>)</label>
      <label><input type="checkbox" id="showNA"> n/a ë³´ê¸° (<span id="naCount">0</span>)</label>
      <label><input type="checkbox" id="showLate"> late ë³´ê¸° (<span id="lateCount">0</span>)</label>
    </div>
    
    <div style="margin-left:auto; display:flex; align-items:center; gap:6px;">
      <label for="tzOffset">íƒ€ì„ì¡´:</label>
      <select id="tzOffset" style="border:1px solid #ccc; border-radius:6px; padding:2px 6px;">
        <script>
          for (let i = 12; i >= -12; i--) {
            const opt = document.createElement("option");
            opt.value = i;
            opt.textContent = i === 9 ? "UTC+9 (KST)" : `UTC${i >= 0 ? "+" + i : i}`;
            if (i === 9) opt.selected = true;
            document.currentScript.parentElement.appendChild(opt);
          }
        </script>
      </select>
    </div>
  </div>



  <h2 style="
    display: flex;
    align-items: baseline;
    gap: 8px;
    margin-bottom: 6px;   /* ğŸ‘ˆ ì•„ë˜ ì—¬ë°±ì„ ì¤„ì„ (ê¸°ë³¸ì€ 16px~20px ìˆ˜ì¤€) */
    margin-top: 14px;       /* ğŸ‘ˆ ìœ„ìª½ ì—¬ë°±ë„ ì‚´ì§ ì¤„ì„ */
  ">
  	ğŸ“ ë¶„ì„ ê²°ê³¼</h2>
  <pre id="result">(ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤)</pre>

</div>

<script>
// === íŒŒì¼ ì„ íƒ ë²„íŠ¼ ì—…ë¡œë“œ ===
document.getElementById("fileInput").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  // íŒŒì¼ëª… í‘œì‹œ
  document.getElementById("fileNameDisplay").textContent = file.name;

  const reader = new FileReader();
  reader.onload = ev => {
    document.getElementById("inputText").value = ev.target.result;
    // íŒŒì¼ ë¡œë“œ í›„ ìë™ ë¶„ì„ ì‹¤í–‰
    document.getElementById("analyzeBtn").click();
  };
  reader.readAsText(file);
});

function htmlEscape(str) {
  return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
}

let sessions = [];

document.getElementById("analyzeBtn").addEventListener("click", () => {
  const text = document.getElementById("inputText").value;
  if (!text.trim()) {
    alert("í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.");
    return;
  }

  const pattern = /start transaction[\s\S]*?stop transaction/gi;
  const matches = text.match(pattern);
  if (!matches) {
    document.getElementById("result").textContent = "ë¶„ì„í•  íŠ¸ëœì­ì…˜ êµ¬ê°„ì´ ì—†ìŠµë‹ˆë‹¤.";
    return;
  }

  sessions = [];

  matches.forEach(block => {
    const lines = block.split(/\r?\n+/).map(l => l.trim()).filter(Boolean);
    let sessionHeader = "Unknown";
    if (lines.length > 1 && /^transaction/i.test(lines[1])) {
      sessionHeader = lines[1].replace(/^start\s+/i, "").trim();
    }

    let urlLine = "ì •ë³´ ì—†ìŒ";
    const timeIdx = lines.findIndex(line => /^time\s*:/i.test(line));
    if (timeIdx !== -1 && lines[timeIdx + 1]) {
      const nextLine = lines[timeIdx + 1].trim();
      if (/^(CONNECT|GET|POST|PUT|DELETE|HEAD|OPTIONS|unknown|ssl|tcp|tls)\s+/i.test(nextLine)) {
        urlLine = nextLine;
      }
    }

    let methodPart = "", urlPart = "";
    const urlParts = urlLine.split(/\s+/);
    if (urlParts.length >= 2) {
      methodPart = urlParts[0];
      urlPart = urlParts.slice(1).join(" ");
    }

    const allLines = [];
    let sectionLineNum = 0;
    let currentSection = null;

    for (let i = 0; i < lines.length; i++) {
      let line = lines[i];
      if (/^start transaction/i.test(line) || /^stop transaction/i.test(line)) continue;
      
      
      // === [ğŸ•’ time: UTC â†’ ì„ íƒëœ ì˜¤í”„ì…‹ ê¸°ì¤€ ë³€í™˜ + yyyy-mm-dd + íƒ€ì„ì¡´ ì•½ì + ìƒ‰ìƒ í‘œì‹œ] ===
      if (/^time\s*:/i.test(line)) {
        const match = line.match(/time\s*:\s*([\d-]+\s+[\d:]+)\s*(UTC)?/i);
        if (match) {
          const utcStr = match[1];
          allLines.push({
            type: "time",
            content: utcStr,
            raw: line    // ì›ë³¸ "time: ..." ì¤„ ì „ì²´ ì €ì¥
          });
          continue;
        }
      }


      // === <...> ì„¹ì…˜ êµ¬ë¶„ì„  í‘œì‹œ ===
      const sectionMatch = line.match(/^<([A-Za-z0-9_\-\s"'\@\:\"\[\]\:]+)>/);
      if (sectionMatch) {
        const sectionName = sectionMatch[1];

        // â‘  ë‚´ë¶€ ì°¸ì¡° ì •ì±… (@ í¬í•¨)
        if (/@/.test(sectionName)) {
          const prevLine = lines[i - 1] || "";

          // â–¶ ì²˜ìŒ ë“±ì¥í•˜ëŠ” @ ì„¹ì…˜ì´ë©´ êµ¬ë¶„ì„  ì¶”ê°€
          if (!lines.slice(0, i).some(l => /^<[^>]*@/.test(l))) {
            allLines.push({
              type: "normal",
              content: `<span style="color:#a1a1a1;"><br>â”€â”€â”€[ ë‚´ë¶€ ì°¸ì¡° ì •ì±… ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>`
            });
          }

          // ë³¸ë¬¸ ì¶œë ¥
          allLines.push({
            type: "normal", content: htmlEscape(line) });
          continue;
        }

        // â‘¡ Local ì •ì±… ([local:] í¬í•¨)
        if (/\[local:/i.test(line)) {
          const alreadyLocal = allLines.some(l => l.content?.includes("â”€â”€â”€[ Local ì •ì±… ]"));
          if (!alreadyLocal) {
            allLines.push({
              type: "normal",
              content: `<span style="color:#F49BAB;"><br>â”€â”€â”€[ Local ì •ì±… ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>`
            });
          }
          allLines.push({
            type: "normal", content: htmlEscape(line)});
          continue;
        }

        // â‘¢ VPM ì •ì±… (@ ì—†ìŒ, [local:] ì—†ìŒ)
        const prevHasAt = lines.slice(0, i).some(l => /^<[^>]*@/.test(l));
        const alreadyVPM = allLines.some(l => l.content?.includes("â”€â”€â”€[ VPM ì •ì±… ]"));
        if (prevHasAt && !alreadyVPM) {
          allLines.push({
            type: "normal",
            content: `<span style="color:#77BEF0;"><br>â”€â”€â”€[ VPM ì •ì±… ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>`
          });
        }

        // ë³¸ë¬¸ ì¶œë ¥
        currentSection = sectionName;
        sectionLineNum = 0;
        allLines.push({
          type: "normal", content: htmlEscape(line) });
        continue;
      }


      if (currentSection) sectionLineNum++;

      
      // condition ë˜ëŠ” Assigned values ~ connection ì „ê¹Œì§€ ì‚­ì œ (connection ì¤„ì€ ë³´ì¡´)
      if (
        /^Matched condition definitions:/i.test(line) ||
        /^Assigned values of transaction variables:/i.test(line)
      ) {
        while (i + 1 < lines.length) {
          // ë‹¤ìŒ ì¤„ì´ connection:ì´ë©´ ì‚­ì œ ì¤‘ë‹¨í•˜ê³  ë‚¨ê¹€
          if (/^connection:/i.test(lines[i + 1])) {
            break;
          }
          i++;
        }
        continue;
      }


      // connection: êµ¬ë¶„ì„  + ë³¸ë¬¸ ì¶œë ¥
      if (/^connection:/i.test(line)) {
        allLines.push({
          type: "normal",
          content: `<span style="color:#E9D484;"><br>===[ Connection Info ]===================================================================================================</span>`
        });
        allLines.push({ type: "normal", content: `<span style="color:#E9D484;">${htmlEscape(line)}</span>`
        });
        continue;
      }
      
      // verdict: êµ¬ë¶„ì„  + ë³¸ë¬¸ ì¶œë ¥
      if (/^verdict:/i.test(line)) {
        allLines.push({
          type: "normal",
          content: `<span style="color:#B7A3E3;"><br>===[ Verdict ]==========================================================================================================</span>`
        });
        allLines.push({ type: "normal", content: `<span style="color:#B7A3E3;">${htmlEscape(line)}</span>`
        });
        continue;
      }
      
      // Transaction timing êµ¬ë¶„ì„  + ë³¸ë¬¸ ì¶œë ¥
      if (/^Transaction timing:/i.test(line)) {
        allLines.push({
          type: "normal",
          content: `<span style="color:#FFD5D5;"><br>===[ Transaction Timing ]===============================================================================================</span>`
        });
        allLines.push({ type: "normal", content: `<span style="color:#FFD5D5;">${htmlEscape(line)}</span>`
        });
        continue;
      }

      if (/^miss:/i.test(line)) {
        allLines.push({ type: "miss", content: `<span class="miss-line">${htmlEscape(line)}</span>` });
        continue;
      }

      if (/^n\/a/i.test(line)) {
        allLines.push({ type: "na", content: `<span class="na-line">${htmlEscape(line)}</span>` });
        continue;
      }
      
      if (/^late:/i.test(line)) {
        allLines.push({ type: "late", content: `<span class="late-line">${htmlEscape(line)}</span>` });
        continue;
      }

      // === [1ï¸âƒ£ MATCH: < ë¡œ ì‹œì‘í•˜ë©´ ë¨¼ì € ì œê±°] ===
      if (/^\s*MATCH:\s*</i.test(line)) {
        line = line.replace(/^MATCH:\s*/i, "");
      }

      // === [2ï¸âƒ£ ì„¹ì…˜ ê¸°ì¤€ì  ê°ì§€] ===
      // '<' ë˜ëŠ” 'MATCH: <'ë¡œ ì‹œì‘í–ˆë˜ ëª¨ë“  ì¤„ì„ ì„¹ì…˜ ê¸°ì¤€ìœ¼ë¡œ ì²˜ë¦¬
      const sectionStartPattern = /^<|^\s*MATCH:\s*</i;
      if (sectionStartPattern.test(lines[i])) {
        currentSection = "section_" + i;  // ê³ ìœ í•œ ì„¹ì…˜ ì‹ë³„ìš© ì´ë¦„
        sectionLineNum = 0;
      }

      // === [3ï¸âƒ£ MATCH ì¹´ìš´íŠ¸ ê³„ì‚°: ë°”ë¡œ ìœ„ ì„¹ì…˜ë¶€í„°ì˜ ìƒëŒ€ ìœ„ì¹˜]
      if (/^MATCH:/i.test(line)) {
        let relativeIndex = 1;
        for (let j = i - 1; j >= 0; j--) {
          // '<' í˜¹ì€ 'MATCH: <' ë§Œë‚˜ëŠ” ìˆœê°„ ì¤‘ë‹¨
          if (/^<|^\s*MATCH:\s*</i.test(lines[j])) break;
          relativeIndex++;
        }
        line = `ã€€(#${relativeIndex}) ${line}`;
      }


      line = htmlEscape(line);
      if (/^\ã€€\(\#\d+\)\s*MATCH:/i.test(line)) line = `<span class="match-line">${line}</span>`;
      else if (/^(client-in:|server-out:)/i.test(line)) line = `<span class="blue-line">${line}</span>`;
      else if (/^(server-in:|client-out:)/i.test(line)) line = `<span class="pink-line">${line}</span>`;
      else if (/^(CONNECT|GET|POST|PUT|DELETE|HEAD|OPTIONS|unknown|ssl|tcp|tls)\s+/i.test(line))
        line = `<span class="url-line">${line}</span>`;

      allLines.push({ type: "normal", content: line });
    }

    sessions.push({ id: sessionHeader, methodPart, urlPart, lines: allLines });
  });

  //=============================================== ì„¸ì…˜ ê´€ë ¨

  const listContainer = document.getElementById("sessionList");
  listContainer.innerHTML = "";
  document.getElementById("sessionSelectorContainer").style.display = "block";
  document.getElementById("filterBox").style.display = "flex";

  sessions.forEach((s, idx) => {
    const div = document.createElement("div");
    div.className = "session-item";
    
    // verdict ì¤„ ì¶”ì¶œ (HTML íƒœê·¸ ì œê±° í›„ ë§¤ì¹­)
    const verdictLine = s.lines.find(l => /verdict:/i.test(l.content || ""));
    let verdictText = "";
    if (verdictLine) {
      // HTML íƒœê·¸ ì œê±°
      const cleanText = verdictLine.content.replace(/<[^>]+>/g, "");
      const match = cleanText.match(/verdict:\s*([A-Z]+(?:\([^)]+\))?)/i);
      if (match) verdictText = match[1];
    }
    
    // verdict ìƒ‰ìƒ êµ¬ë¶„
    let verdictColor = "#000";
    if (/EXCEPTION/i.test(verdictText)) verdictColor = "#b91c1c"; // ì§„í•œ ë¹¨ê°•
    else if (/DENIED/i.test(verdictText)) verdictColor = "#ef4444"; // ë¹¨ê°•
    else if (/ALLOW/i.test(verdictText)) verdictColor = "#10b981"; // ì´ˆë¡

    
    // verdict í‘œì‹œìš© HTML (ì—†ìœ¼ë©´ ë¹ˆì¹¸)
    const verdictHtml = verdictText
      ? `<span style="color:${verdictColor}; font-weight:700;">[${verdictText}]</span> `
      : "";
      
    // ë‘ ë²ˆì§¸ ì¤„ì˜ ë§¨ ì•ì— verdict ì¶”ê°€
    div.innerHTML = `
    <div style="margin-bottom:2px;">
      <span class="session-id">${s.id}</span>
    </div>
    <div style="line-height:1.2;">
      <span class="session-method">${verdictHtml}${s.methodPart}</span>
      <span class="session-url">${s.urlPart}</span>
    </div>
  `;

    div.addEventListener("click", () => {
      document.querySelectorAll(".session-item").forEach(el => el.classList.remove("active-session"));
      div.classList.add("active-session");
      renderSession(idx);
    });

    listContainer.appendChild(div);
  });

  document.querySelectorAll(".session-item")[0].classList.add("active-session");

  // ê²€ìƒ‰ ì…ë ¥ ì‹œ í•„í„°ë§
  document.getElementById("sessionSearchInput").addEventListener("input", (e) => {
    const keyword = e.target.value.trim().toLowerCase();
    const items = document.querySelectorAll(".session-item");

    items.forEach((item, idx) => {
      const s = sessions[idx];
      const text = `${s.id} ${s.methodPart} ${s.urlPart}`.toLowerCase();
      item.style.display = text.includes(keyword) ? "block" : "none";
    });
  });

  renderSession(0);
});



// === UTC â†’ ì„ íƒëœ íƒ€ì„ì¡´ ê¸°ì¤€ ë¡œì»¬ ì‹œê°„ ë³€í™˜ ===
function convertUTCToLocal(utcStr) {
  // ì„ íƒëœ ì˜¤í”„ì…‹ (ê¸°ë³¸ 9)
  const offset = parseInt(document.getElementById("tzOffset")?.value || "9", 10);

  // UTC ê¸°ì¤€ Date ê°ì²´
  const utcDate = new Date(utcStr + " UTC");
  if (isNaN(utcDate)) return utcStr;

  // ì˜¤í”„ì…‹ ê¸°ì¤€ìœ¼ë¡œ ì§ì ‘ ì‹œê°„ ë³´ì • (UTC getterë¡œ ë³´ì •)
  const localTime = utcDate.getTime() + offset * 60 * 60 * 1000;
  const localDate = new Date(localTime);

  const pad = n => String(n).padStart(2, "0");
  const y = localDate.getUTCFullYear();
  const m = pad(localDate.getUTCMonth() + 1);
  const d = pad(localDate.getUTCDate());
  const hh = pad(localDate.getUTCHours());
  const mm = pad(localDate.getUTCMinutes());
  const ss = pad(localDate.getUTCSeconds());

  const tzLabel = offset === 9 ? "KST" : `UTC${offset >= 0 ? "+" + offset : offset}`;
  return `${y}-${m}-${d} ${hh}:${mm}:${ss} ${tzLabel}`;
}




function renderSession(index) {
  const s = sessions[index];
  const showMiss = document.getElementById("showMiss").checked;
  const showNA = document.getElementById("showNA").checked;
  const showLate = document.getElementById("showLate").checked;

  // í˜„ì¬ ì„¸ì…˜ì˜ miss/n/a/late ê°œìˆ˜ ê³„ì‚°
  const missCount = s.lines.filter(l => l.type === "miss").length;
  const naCount = s.lines.filter(l => l.type === "na").length;
  const lateCount = s.lines.filter(l => l.type === "late").length;

  // í•„í„°ë°•ìŠ¤ì— í‘œì‹œê°’ ê°±ì‹ 
  document.getElementById("missCount").textContent = missCount;
  document.getElementById("naCount").textContent = naCount;
  document.getElementById("lateCount").textContent = lateCount;
  
  
  // time ì¤„ì€ ë Œë”ë§ ì‹œì ì—ì„œ ë³€í™˜
  const renderedLines = s.lines.map(l => {
    if (l.type === "time") {
      const converted = convertUTCToLocal(l.content);
      return `${htmlEscape(l.raw)} <span style="color:#ec4899;">(${converted})</span>`;
    }
    return l.content;
  });

  const visibleLines = renderedLines
    .filter((_, idx) => {
      const l = s.lines[idx];
      if (l.type === "miss" && !showMiss) return false;
      if (l.type === "na" && !showNA) return false;
      if (l.type === "late" && !showLate) return false;
      return true;
    })
    .join("\n")
    .replace(/\n{2,}/g, "\n")
    .trim();


  document.getElementById("result").innerHTML = visibleLines;
  
  // ğŸ”¹ ì°¸ê³  ë¬¸ì„œ ë²„íŠ¼ ì¶”ê°€ (ê²°ê³¼ê°€ ìˆì„ ë•Œë§Œ)
  const resultBox = document.getElementById("result");
  let refBtn = document.getElementById("refBtn");
  if (!refBtn) {
    refBtn = document.createElement("button");
    refBtn.id = "refBtn";
    refBtn.textContent = "ğŸ“˜ Timing ìƒì„¸ì„¤ëª… ë³´ê¸°";
    refBtn.style.cssText = `
      position: absolute;
      right: 50px;
      bottom: 35px;
      background: #44444E;
      color: #F7CAC9;
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 0.85rem;
      cursor: pointer;
      opacity: 0.9;
      z-index: 10;
    `;
    
    // ë¶€ëª¨ .containerë¥¼ ìƒëŒ€ìœ„ì¹˜ë¡œ ë§Œë“¤ì–´ì¤Œ
    const container = document.querySelector(".container");
    container.style.position = "relative";
    container.appendChild(refBtn);

    // ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ í‘œì‹œ
    refBtn.addEventListener("click", () => {
      const modal = document.getElementById("refModal");
      const frame = document.getElementById("refFrame");
      frame.src = "https://knowledge.broadcom.com/external/article/168320";
      modal.style.display = "flex";
    });
    // ê²°ê³¼ì°½ ë‚´ë¶€ê°€ preë¼ absolute ë¶ˆê°€ â†’ ìƒìœ„ ì»¨í…Œì´ë„ˆì— append
    document.querySelector(".container").appendChild(refBtn);
  }


  
}


document.getElementById("showMiss").addEventListener("change", () => {
  const idx = [...document.querySelectorAll(".session-item")].findIndex(el => el.classList.contains("active-session"));
  renderSession(idx);
});
document.getElementById("showNA").addEventListener("change", () => {
  const idx = [...document.querySelectorAll(".session-item")].findIndex(el => el.classList.contains("active-session"));
  renderSession(idx);
});
document.getElementById("showLate").addEventListener("change", () => {
  const idx = [...document.querySelectorAll(".session-item")]
    .findIndex(el => el.classList.contains("active-session"));
  renderSession(idx);
});


document.getElementById("downloadBtn").addEventListener("click", () => {
  const html = document.documentElement.outerHTML;
  const blob = new Blob([html], { type: "text/html" });
  const a = document.createElement("a");
  const date = new Date().toISOString().slice(0,10).replace(/-/g,"");
  a.href = URL.createObjectURL(blob);
  a.download = `Trace_Report_${date}.html`;
  a.click();
  URL.revokeObjectURL(a.href);
});


// === ë“œë˜ê·¸ ì•¤ ë“œë¡­ íŒŒì¼ ì—…ë¡œë“œ ê¸°ëŠ¥ ===
const inputArea = document.getElementById("inputText");

inputArea.addEventListener("dragover", (e) => {
  e.preventDefault();
  inputArea.style.borderColor = "#2563eb";
  inputArea.style.background = "#eef2ff";
});

inputArea.addEventListener("dragleave", () => {
  inputArea.style.borderColor = "#d1d5db";
  inputArea.style.background = "#fafafa";
});

// === íƒ€ì„ì¡´ ë³€ê²½ ì‹œ ì¦‰ì‹œ ë°˜ì˜ ===
document.getElementById("tzOffset").addEventListener("change", () => {
  // í˜„ì¬ ì„ íƒëœ ì„¸ì…˜ ì¸ë±ìŠ¤ ì°¾ê¸°
  const idx = [...document.querySelectorAll(".session-item")]
    .findIndex(el => el.classList.contains("active-session"));
  if (idx >= 0) renderSession(idx);
});


inputArea.addEventListener("drop", (e) => {
  e.preventDefault();
  inputArea.style.borderColor = "#d1d5db";
  inputArea.style.background = "#fafafa";

  const file = e.dataTransfer.files[0];
  if (!file) return;
  
  // íŒŒì¼ëª… í‘œì‹œ
  document.getElementById("fileNameDisplay").textContent = file.name;


  const reader = new FileReader();
  reader.onload = (ev) => {
    inputArea.value = ev.target.result;
    // âœ… íŒŒì¼ ë“œë¡­ í›„ ìë™ ë¶„ì„ ì‹¤í–‰
    document.getElementById("analyzeBtn").click();
  };
  reader.readAsText(file);
});


// === ì°¸ê³  ë¬¸ì„œ ëª¨ë‹¬ ì œì–´ ===
document.addEventListener("click", (e) => {
  const modal = document.getElementById("refModal");
  const frame = document.getElementById("refFrame");
  if (!modal) return;

  // ë‹«ê¸° ë²„íŠ¼ í´ë¦­
  if (e.target.id === "closeRef") {
    modal.style.display = "none";
    frame.src = "";
  }

  // ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
  if (e.target.id === "refModal") {
    modal.style.display = "none";
    frame.src = "";
  }
});





</script>


<!-- ğŸ”¹ ì°¸ê³  ë¬¸ì„œ ëª¨ë‹¬ -->
<div id="refModal" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  z-index:9999;
  justify-content:center;
  align-items:center;
">
  <div style="
    background:#fff;
    border-radius:10px;
    box-shadow:0 4px 20px rgba(0,0,0,0.3);
    width:80%;
    height:80%;
    display:flex;
    flex-direction:column;
    overflow:hidden;
    position:relative;
  ">
    <div style="background:#1e3a5f; color:#fff; padding:10px 16px; display:flex; justify-content:space-between; align-items:center;">
      <span style="font-weight:600;">ğŸ”— Broadcom Knowledge Base</span>
      <button id="closeRef" style="
        background:none; border:none; color:#fff; font-size:22px; cursor:pointer; line-height:1;
      ">&times;</button>
    </div>
    <iframe id="refFrame" src="" style="flex:1; border:none; width:100%;"></iframe>
  </div>
</div>




</body>
</html>
